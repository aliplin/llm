# 混合分析威胁检测Agent (IDS系统)

## 系统概述

这是一个基于LLM（大语言模型）的智能入侵检测系统，使用Kimi API进行威胁分析。系统能够：

- 🔍 **实时网络监听**: 监听HTTP和SSH流量
- 🧠 **LLM智能分析**: 使用Kimi API分析可疑行为
- 🛡️ **自动威胁检测**: 检测SQL注入、XSS、SSH暴力破解等攻击
- 🚫 **自动封禁**: 发现威胁时自动封禁恶意IP
- 📊 **可视化监控**: Web界面实时显示系统状态
- 💰 **Token管理**: 智能控制API使用量，避免超额

## 主要功能

### 1. HTTP威胁检测
- 监听端口80的HTTP请求
- 分析请求路径、参数、User-Agent等
- 检测SQL注入、XSS、命令注入等Web攻击
- 自动封禁恶意IP地址

### 2. SSH暴力破解检测
- 监听端口22的SSH连接
- 30秒观察窗口分析连接模式
- 计算SYN/FIN比率等启发式指标
- 检测自动化暴力破解攻击

### 3. Token使用监控
- 实时监控Kimi API使用量
- 每日Token限制管理
- 智能流量控制，避免超额
- Web界面显示使用状态

### 4. Web管理界面
- 实时事件监控
- Token使用统计
- 系统状态查看
- 历史事件查询

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   网络监听模块   │    │   LLM分析模块   │    │   Web管理界面   │
│                 │    │                 │    │                 │
│ • HTTP监听      │───▶│ • Kimi API      │───▶│ • Flask应用     │
│ • SSH监听       │    │ • 威胁分析      │    │ • 实时监控      │
│ • 数据包解析    │    │ • 自动封禁      │    │ • Token管理     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 安装和配置

### 1. 环境要求
- Python 3.8+
- 管理员权限（用于网络监听）
- 网络接口访问权限

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置API密钥
在 `ids_llm.py` 中设置Kimi API密钥：
```python
KIMI_API_KEY = "sk-1C6XrhgtvG2Y47yRYXUauXjkOHgfOLhB3WnCgSODeyHs6a5F"
```

### 4. 配置网络接口
在 `ids_llm.py` 中修改网络接口名称：
```python
pvm_interface = "ens33"  # 根据实际接口名称修改
```

## 使用方法

### 1. 快速启动
```bash
# 使用启动脚本（推荐）
python start_ids.py

# 或分别启动
python app.py          # 启动Web界面
python ids_llm.py      # 启动LLM分析
```

### 2. 访问Web界面
- 地址: http://localhost:5001
- 默认账号: admin
- 默认密码: admin123

### 3. 监控Token使用
- 在仪表盘查看Token使用量
- 访问"LLM分析"页面查看详细状态
- 系统会自动控制API调用频率

## 配置说明

### Token限制配置
```python
# 在 ids_llm.py 中修改
self.token_limit = 1000000  # 每日Token限制
```

### SSH观察窗口
```python
# 在 ids_llm.py 中修改
SSH_OBSERVATION_PERIOD = 30  # 观察窗口时长（秒）
```

### 网络接口配置
```python
# 在 ids_llm.py 中修改
pvm_interface = "ens33"  # 网络接口名称
```

## 功能特性

### 智能流量控制
- 自动检测Token使用量
- 达到限制时暂停LLM分析
- 每日自动重置计数器
- 实时状态监控

### 威胁检测能力
- **Web攻击检测**:
  - SQL注入
  - XSS攻击
  - 命令注入
  - 路径遍历
  - 异常User-Agent

- **SSH攻击检测**:
  - 暴力破解
  - 连接模式分析
  - 启发式指标计算

### 自动响应
- 自动封禁恶意IP
- 管理员通知
- 事件记录
- 实时告警

## 监控和日志

### 日志文件
- `ids.log`: 系统运行日志
- `pending_reviews.json`: 待审核事件

### 数据库
- `ids.db`: SQLite数据库，存储事件和规则

### 实时监控
- Web界面实时显示系统状态
- Token使用量监控
- 网络流量统计

## 故障排除

### 常见问题

1. **权限错误**
   ```
   错误：需要管理员权限来监听网络流量
   解决：使用 sudo python start_ids.py 运行
   ```

2. **网络接口不存在**
   ```
   错误：网络接口 'ens33' 未找到
   解决：使用 ip addr 查看接口名称并修改配置
   ```

3. **API调用失败**
   ```
   错误：调用Kimi API失败
   解决：检查API密钥是否正确，网络连接是否正常
   ```

4. **Token限制**
   ```
   警告：已达到每日token限制
   解决：等待次日重置或修改限制配置
   ```

### 调试模式
```bash
# 启用详细日志
export PYTHONPATH=.
python -u ids_llm.py
```

## 安全注意事项

1. **API密钥安全**
   - 不要在代码中硬编码API密钥
   - 使用环境变量或配置文件
   - 定期轮换密钥

2. **网络权限**
   - 仅在受信任的网络中运行
   - 限制网络接口访问
   - 监控系统资源使用

3. **数据保护**
   - 定期备份数据库
   - 加密敏感数据
   - 限制日志文件访问

## 更新日志

### v1.0.0 (2025-01-XX)
- 初始版本发布
- 支持HTTP和SSH威胁检测
- 集成Kimi API
- Web管理界面
- Token使用监控

## 技术支持

如有问题或建议，请联系开发团队。

---

**注意**: 本系统仅用于学习和研究目的，请勿用于生产环境。 