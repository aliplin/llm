<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时监控 - 入侵检测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        danger: '#F53F3F',
                        warning: '#FF7D00',
                        success: '#00B42A',
                        info: '#86909C',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .sidebar-item {
                @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300;
            }
            .sidebar-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .sidebar-item:not(.active):hover {
                @apply bg-gray-100;
            }
            .stat-card {
                @apply bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90;
            }
            .btn-outline {
                @apply border border-gray-300 hover:bg-gray-100;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90;
            }
            .table-row {
                @apply transition-all duration-300 hover:bg-gray-50;
            }
            .severity-high {
                @apply bg-danger/10 border-l-4 border-danger;
            }
            .severity-medium {
                @apply bg-warning/10 border-l-4 border-warning;
            }
            .severity-low {
                @apply bg-info/10 border-l-4 border-info;
            }
            .new-item {
                animation: fadeIn 0.5s ease-in-out;
            }
            .packet-preview {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .packet-detail {
                display: none;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .show-detail .packet-preview {
                display: none;
            }
            .show-detail .packet-detail {
                display: block;
            }
            .virtual-scroll-container {
                overflow: auto;
                position: relative;
            }
            .virtual-scroll-content {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            @keyframes fadeIn {
                0% { opacity: 0; transform: translateY(10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-50 font-inter text-dark">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block transition-all duration-300">
            <div class="p-5 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold">入侵检测系统</h1>
                </div>
            </div>
            <nav class="p-4">
                <div class="mb-6">
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">主菜单</p>
                    <a href="{{ url_for('main.index') }}" class="sidebar-item">
                        <i class="fa fa-dashboard"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="{{ url_for('main.honeypot_log_analysis') }}" class="sidebar-item">
                        <i class="fa fa-flask"></i>
                        <span>蜜罐网络安全日志分析</span>
                    </a>
                    <a href="{{ url_for('events.events') }}" class="sidebar-item">
                        <i class="fa fa-list-alt"></i>
                        <span>事件日志</span>
                    </a>
                    <a href="{{ url_for('main.realtime') }}" class="sidebar-item active">
                        <i class="fa fa-globe"></i>
                        <span>实时监控</span>
                    </a>
                    <a href="{{ url_for('rules.rules') }}" class="sidebar-item">
                        <i class="fa fa-gavel"></i>
                        <span>检测规则</span>
                    </a>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">系统</p>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-line-chart"></i>
                        <span>性能监控</span>
                    </a>
                </div>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-medium">{{ current_user.username }}</p>
                        <p class="text-xs text-gray-500">管理员</p>
                    </div>
                    <div class="ml-auto">
                        <a href="{{ url_for('auth.logout') }}" class="text-gray-400 hover:text-danger transition-colors">
                            <i class="fa fa-sign-out"></i>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white border-b border-gray-200 py-3 px-6 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden text-gray-500 hover:text-primary mr-4">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <h1 class="text-xl font-bold">实时监控</h1>
                    </div>
                </div>
            </header>

            <!-- 内容区域 -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="mb-8">
                    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">实时监控</h2>
                    <p class="text-gray-500">查看系统实时捕获的数据包和事件</p>
                </div>

                <!-- 控制按钮 -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="startMonitoring" class="btn btn-success">
                        <i class="fa fa-play mr-1"></i> 开始监控
                    </button>
                    <button id="pauseMonitoring" class="btn btn-outline" disabled>
                        <i class="fa fa-pause mr-1"></i> 暂停监控
                    </button>
                    <button id="clearAll" class="btn btn-outline">
                        <i class="fa fa-trash mr-1"></i> 清空所有
                    </button>
                    <div class="ml-auto flex items-center gap-2">
                        <label for="packetLimit" class="text-sm">显示条数:</label>
                        <select id="packetLimit" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">数据包总数</p>
                                <h3 class="text-3xl font-bold" id="packetCount">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                                <i class="fa fa-exchange text-primary text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">检测到的事件</p>
                                <h3 class="text-3xl font-bold" id="eventCount">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-danger/10 rounded-full flex items-center justify-center">
                                <i class="fa fa-exclamation-triangle text-danger text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">当前吞吐量</p>
                                <h3 class="text-3xl font-bold" id="throughput">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center">
                                <i class="fa fa-tachometer text-secondary text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">在线状态</p>
                                <h3 class="text-3xl font-bold" id="status">离线</h3>
                            </div>
                            <div class="w-12 h-12 bg-info/10 rounded-full flex items-center justify-center">
                                <i class="fa fa-server text-info text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 吞吐量图表 -->
                <div class="bg-white rounded-xl p-5 card-shadow mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg">吞吐量图表</h3>
                        <div class="flex items-center gap-2">
                            <select id="chartTimeRange" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="60">最近1分钟</option>
                                <option value="300" selected>最近5分钟</option>
                                <option value="900">最近15分钟</option>
                                <option value="3600">最近1小时</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="throughputChart"></canvas>
                    </div>
                </div>

                <!-- 数据包列表 -->
                <div class="bg-white rounded-xl p-5 card-shadow mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg">数据包列表</h3>
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <input type="text" id="packetSearch" placeholder="搜索..." class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 w-64">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button id="clearPacketList" class="btn btn-outline text-sm">
                                <i class="fa fa-trash mr-1"></i> 清空
                            </button>
                        </div>
                    </div>
                    <div id="packetList" class="virtual-scroll-container" style="height: 400px;">
                        <div id="packetListContent" class="virtual-scroll-content">
                            <div class="text-center text-gray-400 py-10">
                                <i class="fa fa-globe text-4xl mb-2"></i>
                                <p>暂无数据包</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 事件列表 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg">事件列表</h3>
                        <button id="clearEventList" class="btn btn-outline text-sm">
                            <i class="fa fa-trash mr-1"></i> 清空
                        </button>
                    </div>
                    <div id="eventList" class="overflow-x-auto">
                        <div class="text-center text-gray-400 py-10">
                            <i class="fa fa-shield text-4xl mb-2"></i>
                            <p>暂无事件</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 数据包详情模态框 -->
    <div id="packetDetailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">数据包详情</h3>
                <button id="closePacketModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="packetModalContent" class="space-y-4">
                <!-- 数据包详情将在这里动态生成 -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closePacketModalBtn" class="btn btn-primary">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 事件详情模态框 -->
    <div id="eventDetailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">事件详情</h3>
                <button id="closeEventModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="eventModalContent" class="space-y-4">
                <!-- 事件详情将在这里动态生成 -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closeEventModalBtn" class="btn btn-primary">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let packetCounter = 0;
        let eventCounter = 0;
        let isMonitoring = false;
        let throughputData = [];
        let throughputChart;
        let lastPacketTime = Date.now();
        let packetCountPerSecond = 0;
        let allPackets = []; // 存储所有数据包用于搜索
        let visiblePackets = []; // 当前可见的数据包
        let packetHeight = 160; // 每个数据包行的高度，增加高度避免内容挤压
        let packetLimit = 100; // 默认显示100条
        let allEvents = [];
        let eventPage = 1;
        let eventPerPage = 20;

        // 初始化吞吐量图表
        function initChart() {
            const ctx = document.getElementById('throughputChart').getContext('2d');
            const now = Date.now();
            const labels = Array.from({length: 300}, (_, i) => new Date(now - (300 - i) * 1000).toLocaleTimeString([], {second: '2-digit'}));

            throughputData = Array(300).fill(0);

            throughputChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '数据包/秒',
                        data: throughputData,
                        borderColor: '#165DFF',
                        backgroundColor: 'rgba(22, 93, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });
        }

        // 更新吞吐量图表
        function updateThroughputChart() {
            const now = Date.now();
            const secondsSinceLastUpdate = (now - lastPacketTime) / 1000;

            if (secondsSinceLastUpdate >= 1) {
                // 添加新的吞吐量数据点
                throughputData.push(packetCountPerSecond);
                throughputData.shift();

                // 更新图表
                throughputChart.data.datasets[0].data = throughputData;
                throughputChart.update();

                // 更新吞吐量显示
                document.getElementById('throughput').textContent = packetCountPerSecond;

                // 重置计数器
                packetCountPerSecond = 0;
                lastPacketTime = now;
            }
        }

        // 连接成功
        socket.on('connect', () => {
            console.log('已连接到服务器');
            document.getElementById('status').textContent = '在线';
            document.getElementById('status').className = 'text-3xl font-bold text-success';
        });

        // 断开连接
        socket.on('disconnect', () => {
            console.log('与服务器断开连接');
            document.getElementById('status').textContent = '离线';
            document.getElementById('status').className = 'text-3xl font-bold text-danger';
        });

        // 处理数据包
        socket.on('packet', (data) => {
            if (!isMonitoring) return;

            packetCounter++;
            document.getElementById('packetCount').textContent = packetCounter;
            packetCountPerSecond++;
            allPackets.unshift(data.packet); // 添加到搜索列表

            // 限制搜索列表长度
            if (allPackets.length > 10000) {
                allPackets.pop();
            }

            // 只更新可见区域的数据包
            updateVisiblePackets();
        });

        // 处理事件
        socket.on('event', (data) => {
            if (!isMonitoring) {
                // 暂停时不接收新事件，但不影响已渲染事件的交互
                return;
            }
            eventCounter++;
            document.getElementById('eventCount').textContent = eventCounter;
            allEvents.unshift(data.event);
            if (allEvents.length > 1000) allEvents.pop();
            renderEventList();
        });

        // 开始监控
        document.getElementById('startMonitoring').addEventListener('click', () => {
            isMonitoring = true;
            document.getElementById('startMonitoring').disabled = true;
            document.getElementById('pauseMonitoring').disabled = false;
            document.getElementById('startMonitoring').className = 'btn btn-outline';
            document.getElementById('pauseMonitoring').className = 'btn btn-danger';
            console.log('开始实时监控');
        });

        // 暂停监控
        document.getElementById('pauseMonitoring').addEventListener('click', () => {
            isMonitoring = false;
            document.getElementById('startMonitoring').disabled = false;
            document.getElementById('pauseMonitoring').disabled = true;
            document.getElementById('startMonitoring').className = 'btn btn-success';
            document.getElementById('pauseMonitoring').className = 'btn btn-outline';
            console.log('暂停实时监控');
        });

        // 清空所有
        document.getElementById('clearAll').addEventListener('click', () => {
            document.getElementById('packetListContent').innerHTML = `
                <div class="text-center text-gray-400 py-10">
                    <i class="fa fa-globe text-4xl mb-2"></i>
                    <p>暂无数据包</p>
                </div>
            `;
            document.getElementById('eventList').innerHTML = `
                <div class="text-center text-gray-400 py-10">
                    <i class="fa fa-shield text-4xl mb-2"></i>
                    <p>暂无事件</p>
                </div>
            `;
            packetCounter = 0;
            eventCounter = 0;
            document.getElementById('packetCount').textContent = '0';
            document.getElementById('eventCount').textContent = '0';
            allPackets = []; // 清空搜索列表
            visiblePackets = [];
            allEvents = [];
            eventPage = 1;
            console.log('已清空所有数据');
        });

        // 清空数据包列表
        document.getElementById('clearPacketList').addEventListener('click', () => {
            document.getElementById('packetListContent').innerHTML = `
                <div class="text-center text-gray-400 py-10">
                    <i class="fa fa-globe text-4xl mb-2"></i>
                    <p>日志已清空</p>
                </div>
            `;
            packetCounter = 0;
            document.getElementById('packetCount').textContent = '0';
            allPackets = []; // 清空搜索列表
            visiblePackets = [];
        });

        // 清空事件列表
        document.getElementById('clearEventList').addEventListener('click', () => {
            allEvents = [];
            eventPage = 1;
            renderEventList();
            eventCounter = 0;
            document.getElementById('eventCount').textContent = '0';
        });

        // 搜索数据包
        document.getElementById('packetSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();

            // 如果搜索框为空，显示所有数据包
            if (searchTerm === '') {
                updateVisiblePackets();
                return;
            }

            // 过滤匹配的数据包
            const filteredPackets = allPackets.filter(packet => {
                return packet.src_ip.toLowerCase().includes(searchTerm) ||
                       packet.dst_ip.toLowerCase().includes(searchTerm) ||
                       packet.protocol.toLowerCase().includes(searchTerm) ||
                       (packet.payload && packet.payload.toLowerCase().includes(searchTerm));
            });

            renderPackets(filteredPackets);
        });

        // 设置显示条数限制
        document.getElementById('packetLimit').addEventListener('change', (e) => {
            packetLimit = parseInt(e.target.value);
            updateVisiblePackets();
        });

        // 渲染数据包列表
        function renderPackets(packets) {
            const packetListContent = document.getElementById('packetListContent');

            // 清空现有列表
            packetListContent.innerHTML = '';

            // 如果没有匹配的数据包，显示提示信息
            if (packets.length === 0) {
                packetListContent.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <i class="fa fa-search text-4xl mb-2"></i>
                        <p>没有找到匹配的数据包</p>
                    </div>
                `;
                return;
            }

            // 计算内容高度
            packetListContent.style.height = `${packets.length * packetHeight}px`;

            // 渲染可见区域的数据包
            const container = document.getElementById('packetList');
            const { scrollTop, clientHeight } = container;
            const startIndex = Math.floor(scrollTop / packetHeight);
            const endIndex = Math.min(startIndex + Math.ceil(clientHeight / packetHeight), packets.length);

            for (let i = startIndex; i < endIndex; i++) {
                const packet = packets[i];
                const packetItem = createPacketElement(packet, i);
                packetItem.style.top = `${i * packetHeight}px`;
                packetListContent.appendChild(packetItem);
            }

            visiblePackets = packets;
        }

        // 创建数据包元素
        function createPacketElement(packet, index) {
            // 根据协议设置不同的图标和颜色
            let protocolIcon = 'fa-exchange';
            let protocolColor = 'text-primary';

            if (packet.protocol === 'TCP') {
                protocolIcon = 'fa-arrows-h';
                protocolColor = 'text-primary';
            } else if (packet.protocol === 'UDP') {
                protocolIcon = 'fa-paper-plane';
                protocolColor = 'text-secondary';
            } else if (packet.protocol === 'HTTP') {
                protocolIcon = 'fa-globe';
                protocolColor = 'text-success';
            } else if (packet.protocol === 'HTTPS') {
                protocolIcon = 'fa-lock';
                protocolColor = 'text-success';
            } else if (packet.protocol === 'DNS') {
                protocolIcon = 'fa-server';
                protocolColor = 'text-warning';
            }

            const packetItem = document.createElement('div');
            packetItem.className = 'border-b border-gray-200 py-3 px-4 absolute w-full';
            packetItem.style.height = `${packetHeight}px`;
            packetItem.innerHTML = `
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-500">时间</p>
                                <p class="font-medium">${packet.time}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">源IP</p>
                                <p class="font-medium">${packet.src_ip}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">目标IP</p>
                                <p class="font-medium">${packet.dst_ip}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">协议</p>
                                <div class="flex items-center">
                                    <i class="fa ${protocolIcon} ${protocolColor} mr-2"></i>
                                    <span class="font-medium">${packet.protocol}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-500">源端口</p>
                                <p class="font-medium">${packet.src_port}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">目标端口</p>
                                <p class="font-medium">${packet.dst_port}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return packetItem;
        }

        // 更新可见区域的数据包
        function updateVisiblePackets() {
            // 限制显示的数据包数量
            const displayPackets = allPackets.slice(0, packetLimit);
            renderPackets(displayPackets);
        }

        // 处理虚拟滚动
        document.getElementById('packetList').addEventListener('scroll', () => {
            updateVisiblePackets();
        });

        // 查看数据包详情
        document.addEventListener('click', (e) => {
            if (e.target.closest('.view-packet-details')) {
                const btn = e.target.closest('.view-packet-details');
                const details = JSON.parse(btn.getAttribute('data-details'));

                const modalContent = document.getElementById('packetModalContent');
                modalContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">时间</p>
                            <p class="font-medium">${details.time}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">协议</p>
                            <p class="font-medium">${details.protocol}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">源IP</p>
                            <p class="font-medium">${details.src_ip}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">目标IP</p>
                            <p class="font-medium">${details.dst_ip}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">源端口</p>
                            <p class="font-medium">${details.src_port}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">目标端口</p>
                            <p class="font-medium">${details.dst_port}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">数据包大小</p>
                            <p class="font-medium">${details.size} 字节</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">TTL</p>
                            <p class="font-medium">${details.ttl}</p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h4 class="font-bold mb-2">数据包头部</h4>
                        <div class="bg-gray-50 p-4 rounded-lg text-sm overflow-x-auto">
                            <pre>${JSON.stringify(details.header, null, 2)}</pre>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h4 class="font-bold mb-2">数据包负载</h4>
                        <div class="bg-gray-50 p-4 rounded-lg text-sm overflow-x-auto max-h-60">
                            <pre>${details.payload}</pre>
                        </div>
                    </div>
                `;

                document.getElementById('packetDetailModal').classList.remove('hidden');
            }
        });

        // 渲染事件列表（带分页）
        function renderEventList() {
            const eventList = document.getElementById('eventList');
            eventList.innerHTML = '';
            const start = (eventPage - 1) * eventPerPage;
            const end = Math.min(start + eventPerPage, allEvents.length);
            if (allEvents.length === 0) {
                eventList.innerHTML = `<div class="text-center text-gray-400 py-10"><i class="fa fa-shield text-4xl mb-2"></i><p>暂无事件</p></div>`;
                document.getElementById('eventPagination').innerHTML = '';
                return;
            }
            for (let i = start; i < end; i++) {
                const data = allEvents[i];
                let severityClass = 'severity-high';
                if (data.severity === 'medium') severityClass = 'severity-medium';
                else if (data.severity === 'low') severityClass = 'severity-low';
                const eventItem = document.createElement('div');
                eventItem.className = `${severityClass} py-3 px-4 new-item mb-2 rounded-lg`;
                eventItem.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div><p class="text-xs text-gray-500">时间</p><p class="font-medium">${data.time}</p></div>
                                <div><p class="text-xs text-gray-500">IP地址</p><p class="font-medium">${data.ip}</p></div>
                                <div><p class="text-xs text-gray-500">规则名称</p><p class="font-medium">${data.rule_name}</p></div>
                                <div><p class="text-xs text-gray-500">严重级别</p><p class="font-medium ${data.severity === 'high' ? 'text-danger' : data.severity === 'medium' ? 'text-warning' : 'text-info'}">${data.severity}</p></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-outline text-xs view-event-details" data-details='${JSON.stringify(data)}'><i class="fa fa-info-circle mr-1"></i> 查看详情</button>
                            <button class="btn btn-danger text-xs block-ip" data-ip="${data.ip}"><i class="fa fa-ban mr-1"></i> 阻止IP</button>
                        </div>
                    </div>
                `;
                eventList.appendChild(eventItem);
            }
            renderEventPagination();
        }
        // 渲染事件分页按钮
        function renderEventPagination() {
            const container = document.getElementById('eventPagination');
            if (!container) return;
            container.innerHTML = '';
            const totalPages = Math.ceil(allEvents.length / eventPerPage);
            if (totalPages <= 1) return;
            // 上一页
            const prevBtn = document.createElement('button');
            prevBtn.className = 'w-8 h-8 mx-1 rounded border border-gray-300 text-gray-500 hover:bg-gray-100';
            prevBtn.innerHTML = '<i class="fa fa-angle-left"></i>';
            prevBtn.disabled = eventPage <= 1;
            prevBtn.onclick = () => { eventPage--; renderEventList(); };
            container.appendChild(prevBtn);
            // 页码按钮（最多显示5页）
            let start = Math.max(1, eventPage - 2);
            let end = Math.min(totalPages, start + 4);
            if (end - start < 4) start = Math.max(1, end - 4);
            for (let i = start; i <= end; i++) {
                const btn = document.createElement('button');
                btn.className = 'w-8 h-8 mx-1 rounded border ' + (i === eventPage ? 'bg-primary text-white' : 'border-gray-300 hover:bg-gray-100');
                btn.textContent = i;
                btn.onclick = () => { eventPage = i; renderEventList(); };
                container.appendChild(btn);
            }
            // 下一页
            const nextBtn = document.createElement('button');
            nextBtn.className = 'w-8 h-8 mx-1 rounded border border-gray-300 text-gray-500 hover:bg-gray-100';
            nextBtn.innerHTML = '<i class="fa fa-angle-right"></i>';
            nextBtn.disabled = eventPage >= totalPages;
            nextBtn.onclick = () => { eventPage++; renderEventList(); };
            container.appendChild(nextBtn);
        }

        // 查看事件详情（不受暂停影响）
        document.addEventListener('click', (e) => {
            if (e.target.closest('.view-event-details')) {
                const btn = e.target.closest('.view-event-details');
                const details = JSON.parse(btn.getAttribute('data-details'));
                const modalContent = document.getElementById('eventModalContent');
                modalContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><p class="text-sm text-gray-500">规则ID</p><p class="font-medium">${details.rule_id}</p></div>
                        <div><p class="text-sm text-gray-500">规则名称</p><p class="font-medium">${details.rule_name}</p></div>
                        <div><p class="text-sm text-gray-500">事件类型</p><p class="font-medium">${details.event_type}</p></div>
                        <div><p class="text-sm text-gray-500">严重级别</p><p class="font-medium ${details.severity === 'high' ? 'text-danger' : details.severity === 'medium' ? 'text-warning' : 'text-info'}">${details.severity}</p></div>
                        <div><p class="text-sm text-gray-500">描述</p><p class="font-medium">${details.description}</p></div>
                        <div><p class="text-sm text-gray-500">匹配模式</p><p class="font-medium">${details.matched_pattern}</p></div>
                        <div><p class="text-sm text-gray-500">IP地址</p><p class="font-medium">${details.ip}</p></div>
                        <div><p class="text-sm text-gray-500">请求路径</p><p class="font-medium">${details.path}</p></div>
                        <div><p class="text-sm text-gray-500">时间</p><p class="font-medium">${details.time}</p></div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold mb-2">请求数据</h4>
                        <div class="bg-gray-50 p-4 rounded-lg text-sm">
                            <pre>${JSON.stringify(details.request_data, null, 2)}</pre>
                        </div>
                    </div>
                `;
                document.getElementById('eventDetailModal').classList.remove('hidden');
            }
        });

        // 关闭数据包详情模态框
        document.getElementById('closePacketModal').addEventListener('click', () => {
            document.getElementById('packetDetailModal').classList.add('hidden');
        });

        document.getElementById('closePacketModalBtn').addEventListener('click', () => {
            document.getElementById('packetDetailModal').classList.add('hidden');
        });

        // 关闭事件详情模态框
        document.getElementById('closeEventModal').addEventListener('click', () => {
            document.getElementById('eventDetailModal').classList.add('hidden');
        });

        document.getElementById('closeEventModalBtn').addEventListener('click', () => {
            document.getElementById('eventDetailModal').classList.add('hidden');
        });

        // 阻止IP
        document.addEventListener('click', (e) => {
            if (e.target.closest('.block-ip')) {
                const btn = e.target.closest('.block-ip');
                const ip = btn.getAttribute('data-ip');

                if (confirm(`确定要阻止 IP ${ip} 吗？`)) {
                    fetch('/api/block_ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ip, duration: 3600 })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`IP ${ip} 已被阻止`);
                        } else {
                            alert(`阻止 IP ${ip} 失败: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        alert(`发生错误: ${error.message}`);
                    });
                }
            }
        });

        // 切换图表时间范围
        document.getElementById('chartTimeRange').addEventListener('change', (e) => {
            const seconds = parseInt(e.target.value);
            const now = Date.now();
            const labels = Array.from({length: seconds}, (_, i) => new Date(now - (seconds - i) * 1000).toLocaleTimeString([], {second: '2-digit'}));

            // 重置数据
            throughputData = Array(seconds).fill(0);

            // 更新图表
            throughputChart.data.labels = labels;
            throughputChart.data.datasets[0].data = throughputData;
            throughputChart.update();
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            initChart();

            // 每秒更新一次吞吐量图表
            setInterval(updateThroughputChart, 1000);

            // 默认开始监控
            document.getElementById('startMonitoring').click();

            // 初始化虚拟滚动
            updateVisiblePackets();

            if (!document.getElementById('eventPagination')) {
                const eventList = document.getElementById('eventList');
                const pagDiv = document.createElement('div');
                pagDiv.id = 'eventPagination';
                pagDiv.className = 'flex justify-center items-center mt-4';
                eventList.parentNode.appendChild(pagDiv);
            }
            renderEventList();
        });
    </script>
</body>
</html>
