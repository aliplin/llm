<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蜜罐日志分析 - 入侵检测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        danger: '#F53F3F',
                        warning: '#FF7D00',
                        success: '#00B42A',
                        info: '#86909C',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .sidebar-item {
                @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300;
            }
            .sidebar-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .sidebar-item:not(.active):hover {
                @apply bg-gray-100;
            }
            .stat-card {
                @apply bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90;
            }
            .btn-outline {
                @apply border border-gray-300 hover:bg-gray-100;
            }
            .table-row {
                @apply transition-all duration-300 hover:bg-gray-50;
            }
            .service-btn {
                @apply px-4 py-2 rounded-lg border border-gray-200 font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .service-btn.active {
                @apply bg-primary/10 text-primary border-primary;
            }
            .log-filter {
                @apply px-4 py-2 rounded-lg border border-gray-200 font-medium transition-all duration-300 flex items-center justify-center gap-2 mr-2 mb-2;
            }
            .log-filter.active {
                @apply bg-primary/10 text-primary border-primary;
            }
            .log-container {
                @apply mt-4 max-h-96 overflow-y-auto;
            }
            .log-entry {
                @apply p-3 border-b border-gray-100;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block transition-all duration-300">
            <div class="p-5 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold">入侵检测系统</h1>
                </div>
            </div>
            <nav class="p-4">
                <div class="mb-6">
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">主菜单</p>
                    <a href="{{ url_for('main.index') }}" class="sidebar-item">
                        <i class="fa fa-dashboard"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="{{ url_for('main.honeypot_log_analysis') }}" class="sidebar-item active">
                        <i class="fa fa-flask"></i>
                        <span>蜜罐网络安全日志分析</span>
                    </a>
                    <a href="{{ url_for('events.events') }}" class="sidebar-item">
                        <i class="fa fa-list-alt"></i>
                        <span>事件日志</span>
                    </a>
                    <a href="{{ url_for('main.realtime') }}" class="sidebar-item">
                        <i class="fa fa-globe"></i>
                        <span>实时监控</span>
                    </a>
                    <a href="{{ url_for('rules.rules') }}" class="sidebar-item">
                        <i class="fa fa-gavel"></i>
                        <span>检测规则</span>
                    </a>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">系统</p>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-line-chart"></i>
                        <span>性能监控</span>
                    </a>
                </div>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-medium">{{ current_user.username }}</p>
                        <p class="text-xs text-gray-500">管理员</p>
                    </div>
                    <div class="ml-auto">
                        <a href="{{ url_for('auth.logout') }}" class="text-gray-400 hover:text-danger transition-colors">
                            <i class="fa fa-sign-out"></i>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white border-b border-gray-200 py-3 px-6 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden text-gray-500 hover:text-primary mr-4">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <h1 class="text-xl font-bold">蜜罐日志分析</h1>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="relative text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-bell text-xl"></i>
                        <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-4 h-4 flex items-center justify-center rounded-full">3</span>
                    </button>
                    <button class="text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-question-circle text-xl"></i>
                    </button>
                    <div class="hidden md:flex items-center gap-3">
                        <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
                        <span class="font-medium">{{ current_user.username }}</span>
                    </div>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="mb-8">
                    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">蜜罐日志分析</h2>
                    <p class="text-gray-500">实时监控蜜罐系统的安全状态</p>
                </div>

                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">总会话数</h3>
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <i class="fa fa-users"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="total-sessions">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">攻击事件</h3>
                            <div class="w-10 h-10 rounded-full bg-danger/10 flex items-center justify-center text-danger">
                                <i class="fa fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="total-attacks">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">活跃会话</h3>
                            <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                                <i class="fa fa-user"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="active-sessions">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">最后更新</h3>
                            <div class="w-10 h-10 rounded-full bg-info/10 flex items-center justify-center text-info">
                                <i class="fa fa-clock"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="last-update">--</p>
                        </div>
                    </div>
                </div>

                <!-- 控制面板 -->
                <div class="bg-white rounded-xl p-5 card-shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <h3><i class="fa fa-cogs"></i> 数据控制</h3>
                            <div class="flex gap-3">
                                <button id="refreshBtn" class="btn btn-primary">
                                    <i class="fa fa-sync-alt"></i> 刷新数据
                                </button>
                                <button id="exportBtn" class="btn btn-secondary">
                                    <i class="fa fa-download"></i> 导出报告
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3><i class="fa fa-filter"></i> 服务筛选</h3>
                            <div class="flex flex-wrap gap-2">
                                <button id="sshSessionsBtn" class="service-btn active">
                                    <i class="fa fa-terminal"></i> SSH
                                </button>
                                <button id="httpSessionsBtn" class="service-btn">
                                    <i class="fa fa-globe"></i> HTTP
                                </button>
                                <button id="mysqlSessionsBtn" class="service-btn">
                                    <i class="fa fa-database"></i> MySQL
                                </button>
                                <button id="pop3SessionsBtn" class="service-btn">
                                    <i class="fa fa-envelope"></i> POP3
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3><i class="fa fa-chart-line"></i> 时间范围</h3>
                            <select id="timeRange" class="form-select">
                                <option value="1">最近1小时</option>
                                <option value="24" selected>最近24小时</option>
                                <option value="168">最近7天</option>
                                <option value="720">最近30天</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-line"></i> 会话趋势</h3>
                        <div class="h-80">
                            <canvas id="sessionsTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-pie"></i> 服务分布</h3>
                        <div class="h-80">
                            <canvas id="serviceDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-bar"></i> 攻击类型统计</h3>
                        <div class="h-80">
                            <canvas id="attackTypesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 实时日志流 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3><i class="fa fa-stream"></i> 实时日志流</h3>
                    <div class="log-filters flex flex-wrap mb-4">
                        <button class="log-filter active" data-level="all">全部</button>
                        <button class="log-filter" data-level="info">信息</button>
                        <button class="log-filter" data-level="warning">警告</button>
                        <button class="log-filter" data-level="error">错误</button>
                    </div>
                    <div id="realtimeLogs" class="log-container">
                        <div class="text-gray-500 text-center py-10">加载中...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        // 全局变量存储图表实例
        let serviceDistributionChart = null;
        let attackTypesChart = null;
        let sessionsTrendChart = null;

        // 初始化仪表板
        async function initializeDashboard() {
            console.log('Initializing dashboard...');
            await updateStats();
            await initializeCharts();
            setupEventListeners();
            updateLastUpdateTime();

            // 设置定时刷新
            setInterval(async () => {
                await updateStats();
                await updateCharts();
                await loadRealtimeLogs();
                updateLastUpdateTime();
            }, 30000); // 每30秒刷新一次
        }

        // 更新统计信息
        async function updateStats() {
            try {
                const response = await fetch('/api/overview-stats');
                const data = await response.json();

                document.getElementById('total-sessions').textContent = data.total_sessions;
                document.getElementById('total-attacks').textContent = data.total_attacks || data.total_sessions;
                document.getElementById('active-sessions').textContent = data.active_sessions || 0;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        // 初始化图表
        async function initializeCharts() {
            try {
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                // 服务分布图表
                const serviceDistributionCtx = document.getElementById('serviceDistributionChart').getContext('2d');
                serviceDistributionChart = new Chart(serviceDistributionCtx, {
                    type: 'pie',
                    data: {
                        labels: data.service_distribution.labels,
                        datasets: [
                            {
                                data: data.service_distribution.data,
                                backgroundColor: ['#165DFF', '#0FC6C2', '#F53F3F', '#FF7D00']
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
                // 攻击类型统计图表
                const attackTypesCtx = document.getElementById('attackTypesChart').getContext('2d');
                attackTypesChart = new Chart(attackTypesCtx, {
                    type: 'bar',
                    data: {
                        labels: data.attack_types.labels,
                        datasets: [
                            {
                                label: '攻击次数',
                                data: data.attack_types.data,
                                backgroundColor: '#165DFF'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                // 会话趋势图表
                await loadSessionTrendChart();
                // 加载实时日志
                await loadRealtimeLogs();
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // 更新图表数据
        async function updateCharts() {
            try {
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                // 更新服务分布图表
                if (serviceDistributionChart) {
                    serviceDistributionChart.data.datasets[0].data = data.service_distribution.data;
                    serviceDistributionChart.update();
                }
                // 更新攻击类型图表
                if (attackTypesChart) {
                    attackTypesChart.data.datasets[0].data = data.attack_types.data;
                    attackTypesChart.update();
                }
                // 更新会话趋势图表
                await loadSessionTrendChart();
                // 更新实时日志
                await loadRealtimeLogs();
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // 加载会话趋势图表
        async function loadSessionTrendChart() {
            try {
                const timeRange = document.getElementById('timeRange').value;
                const response = await fetch(`/api/session-trend?time_range=${timeRange}`);
                const data = await response.json();

                const ctx = document.getElementById('sessionsTrendChart').getContext('2d');

                // 如果图表已存在，销毁它
                if (sessionsTrendChart) {
                    sessionsTrendChart.destroy();
                }

                // 创建新图表
                sessionsTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'SSH会话',
                                data: data.ssh_sessions,
                                borderColor: '#165DFF',
                                backgroundColor: 'rgba(22, 93, 255, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'HTTP会话',
                                data: data.http_sessions,
                                borderColor: '#0FC6C2',
                                backgroundColor: 'rgba(15, 198, 194, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'MySQL会话',
                                data: data.mysql_sessions,
                                borderColor: '#F53F3F',
                                backgroundColor: 'rgba(245, 63, 63, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'POP3会话',
                                data: data.pop3_sessions,
                                borderColor: '#FF7D00',
                                backgroundColor: 'rgba(255, 125, 0, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching session trend data:', error);
            }
        }

        // 加载实时日志
        async function loadRealtimeLogs() {
            try {
                const selectedLevel = document.querySelector('.log-filter.active').dataset.level;
                const response = await fetch(`/api/realtime-logs?level=${selectedLevel}`);
                const logs = await response.json();

                const logsContainer = document.getElementById('realtimeLogs');

                // 清空现有日志
                logsContainer.innerHTML = '';

                if (logs.length === 0) {
                    logsContainer.innerHTML = '<div class="text-gray-500 text-center py-10">暂无日志数据</div>';
                    return;
                }

                logs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = `log-entry p-3 border-b border-gray-100 ${getLogLevelClass(log.level)}`;

                    const timestamp = new Date(log.timestamp).toLocaleString();

                    logElement.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-medium">${log.source}</span>
                            <span class="text-xs text-gray-500">${timestamp}</span>
                        </div>
                        <p class="text-sm">${log.message}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs ${getLogLevelTextClass(log.level)}">${log.level.toUpperCase()}</span>
                            <span class="text-xs text-gray-500">${log.ip || '-'}</span>
                        </div>
                    `;

                    logsContainer.appendChild(logElement);
                });

                // 滚动到底部
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } catch (error) {
                console.error('Error fetching realtime logs:', error);
                document.getElementById('realtimeLogs').innerHTML = '<div class="text-red-500 text-center py-10">加载日志失败</div>';
            }
        }

        // 获取日志级别对应的CSS类
        function getLogLevelClass(level) {
            switch (level.toLowerCase()) {
                case 'info':
                    return 'bg-blue-50';
                case 'warning':
                    return 'bg-yellow-50';
                case 'error':
                    return 'bg-red-50';
                default:
                    return '';
            }
        }

        // 获取日志级别文本对应的CSS类
        function getLogLevelTextClass(level) {
            switch (level.toLowerCase()) {
                case 'info':
                    return 'text-blue-600';
                case 'warning':
                    return 'text-yellow-600';
                case 'error':
                    return 'text-red-600';
                default:
                    return 'text-gray-600';
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                await updateStats();
                await updateCharts();
                updateLastUpdateTime();
                showNotification('数据已刷新');
            });

            // 服务筛选按钮
            document.querySelectorAll('.service-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.service-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // 这里可以添加服务筛选逻辑
                    loadSessionTrendChart();
                });
            });

            // 时间范围选择
            document.getElementById('timeRange').addEventListener('change', loadSessionTrendChart);

            // 日志过滤器
            document.querySelectorAll('.log-filter').forEach(filter => {
                filter.addEventListener('click', () => {
                    document.querySelectorAll('.log-filter').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    loadRealtimeLogs();
                });
            });
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update');
            const now = new Date();
            const dateTime = now.toLocaleString();
            lastUpdateElement.textContent = dateTime;
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${getNotificationClass(type)}`;

            const iconMap = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle'
            };

            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fa ${iconMap[type]}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);

            // 自动关闭
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 获取通知类型对应的CSS类
        function getNotificationClass(type) {
            switch (type) {
                case 'success':
                    return 'bg-green-50 text-green-800 border-l-4 border-green-400';
                case 'error':
                    return 'bg-red-50 text-red-800 border-l-4 border-red-400';
                case 'warning':
                    return 'bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400';
                default:
                    return 'bg-blue-50 text-blue-800 border-l-4 border-blue-400';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>