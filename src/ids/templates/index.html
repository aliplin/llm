<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入侵检测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        danger: '#F53F3F',
                        warning: '#FF7D00',
                        success: '#00B42A',
                        info: '#86909C',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .sidebar-item {
                @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300;
            }
            .sidebar-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .sidebar-item:not(.active):hover {
                @apply bg-gray-100;
            }
            .stat-card {
                @apply bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90;
            }
            .btn-outline {
                @apply border border-gray-300 hover:bg-gray-100;
            }
            .table-row {
                @apply transition-all duration-300 hover:bg-gray-50;
            }
            .new-event-row {
                animation: fadeIn 0.5s ease-in;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block transition-all duration-300">
            <div class="p-5 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold">入侵检测系统</h1>
                </div>
            </div>
            <nav class="p-4">
                <div class="mb-6">
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">主菜单</p>
                    <a href="{{ url_for('main.index') }}" class="sidebar-item">
                        <i class="fa fa-dashboard"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="{{ url_for('main.honeypot_log_analysis') }}" class="sidebar-item">
                        <i class="fa fa-flask"></i>
                        <span>蜜罐网络安全日志分析</span>
                    </a>
                    <a href="{{ url_for('main.llm_status') }}" class="sidebar-item">
                        <i class="fa fa-brain"></i>
                        <span>LLM状态</span>
                    </a>
                    <a href="{{ url_for('events.events') }}" class="sidebar-item">
                        <i class="fa fa-list-alt"></i>
                        <span>事件日志</span>
                    </a>
                    <a href="{{ url_for('main.realtime') }}" class="sidebar-item">
                        <i class="fa fa-globe"></i>
                        <span>实时监控</span>
                    </a>
                    <a href="{{ url_for('rules.rules') }}" class="sidebar-item">
                        <i class="fa fa-gavel"></i>
                        <span>检测规则</span>
                    </a>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">系统</p>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-line-chart"></i>
                        <span>性能监控</span>
                    </a>
                </div>
            </nav>

            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-medium">{{ current_user.username }}</p>
                        <p class="text-xs text-gray-500">管理员</p>
                    </div>
                    <div class="ml-auto">
                        <a href="{{ url_for('auth.logout') }}" class="text-gray-400 hover:text-danger transition-colors">
                            <i class="fa fa-sign-out"></i>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white border-b border-gray-200 py-3 px-6 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden text-gray-500 hover:text-primary mr-4">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <input type="text" placeholder="搜索事件、规则..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 w-64">
                        <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="relative text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-bell text-xl"></i>
                        <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-4 h-4 flex items-center justify-center rounded-full">3</span>
                    </button>
                    <button class="text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-question-circle text-xl"></i>
                    </button>
                    <div class="hidden md:flex items-center gap-3">
                        <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
                        <span class="font-medium">{{ current_user.username }}</span>
                    </div>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="mb-8">
                    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">仪表盘</h2>
                    <p class="text-gray-500">实时监控系统安全状态</p>
                </div>

                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">今日事件</h3>
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <i class="fa fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="todayEvents">-</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">今日检测到的事件</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">高风险事件</h3>
                            <div class="w-10 h-10 rounded-full bg-danger/10 flex items-center justify-center text-danger">
                                <i class="fa fa-shield"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="highRiskEvents">-</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">高风险事件总数</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">事件类型数</h3>
                            <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                                <i class="fa fa-gavel"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="eventTypes">-</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">事件类型种类</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">事件总数</h3>
                            <div class="w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                                <i class="fa fa-line-chart"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="totalEvents">-</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">所有事件累计</p>
                    </div>
                </div>

                <!-- 图表和最近事件 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white rounded-xl p-5 card-shadow">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-lg">事件趋势</h3>
                        </div>
                        <div class="h-80">
                            <canvas id="eventTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-bold text-lg">事件分类</h3>
                        </div>
                        <div class="h-80">
                            <canvas id="eventTypeChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 最近事件表格 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <h3 class="font-bold text-lg">最近事件</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500">实时更新</span>
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="btn btn-outline text-sm" onclick="refreshRecentEvents()">
                                <i class="fa fa-refresh mr-1"></i> 刷新
                            </button>
                            <a href="{{ url_for('events.events') }}" class="text-primary hover:text-primary/80 text-sm flex items-center gap-1">
                                查看全部 <i class="fa fa-angle-right"></i>
                            </a>
                        </div>
                    </div>
                    
                    <!-- 事件统计摘要 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600" id="recentHighRisk">0</div>
                            <div class="text-xs text-gray-500">高风险</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="recentMediumRisk">0</div>
                            <div class="text-xs text-gray-500">中风险</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="recentLowRisk">0</div>
                            <div class="text-xs text-gray-500">低风险</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="recentTotal">0</div>
                            <div class="text-xs text-gray-500">总计</div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">时间</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">IP地址</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">事件类型</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">严重级别</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">状态</th>
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-500">操作</th>
                                </tr>
                            </thead>
                            <tbody id="recentEventsTable">
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 加载状态 -->
                    <div id="recentEventsLoading" class="text-center py-8 hidden">
                        <div class="inline-flex items-center gap-2 text-gray-500">
                            <i class="fa fa-spinner fa-spin"></i>
                            <span>加载中...</span>
                        </div>
                    </div>
                    
                    <!-- 空状态 -->
                    <div id="recentEventsEmpty" class="text-center py-12 hidden">
                        <i class="fa fa-shield text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无最近事件</p>
                        <p class="text-sm text-gray-400 mt-1">系统正在监控中...</p>
                    </div>
                    
                    <!-- 错误状态 -->
                    <div id="recentEventsError" class="text-center py-8 hidden">
                        <i class="fa fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                        <p class="text-red-500">加载失败，请重试</p>
                        <button class="btn btn-outline mt-3" onclick="loadRecentEvents()">
                            <i class="fa fa-refresh mr-1"></i> 重新加载
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 事件详情模态框 -->
    <div id="eventDetailsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-5 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-bold text-lg">事件详情</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-5" id="modalContent">
                <!-- 内容将通过JavaScript动态填充 -->
            </div>
            <div class="p-5 border-t border-gray-200 flex justify-end gap-3">
                <button class="btn btn-outline" id="closeModalBtn">关闭</button>
                <button class="btn btn-danger">
                    <i class="fa fa-ban mr-1"></i> 阻止IP
                </button>
            </div>
        </div>
    </div>

    <script>
        let trendChart = null;
        let typeChart = null;
        let socket = null;
        let realtimeData = {
            todayEvents: 0,
            highRiskEvents: 0,
            eventTypes: 0,
            totalEvents: 0,
            trendData: [],
            typeData: []
        };
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Socket.IO连接
            initSocketConnection();
            
            // 侧边栏切换
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                const sidebar = document.querySelector('aside');
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('fixed');
                sidebar.classList.toggle('inset-y-0');
                sidebar.classList.toggle('left-0');
                sidebar.classList.toggle('z-50');
            });

            // 模态框关闭按钮
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('eventDetailsModal').classList.add('hidden');
            });

            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.getElementById('eventDetailsModal').classList.add('hidden');
            });

            // 点击模态框背景关闭
            document.getElementById('eventDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.getElementById('eventDetailsModal').classList.add('hidden');
                }
            });

            // 初始化加载数据
            loadDashboardData();
            loadRecentEvents();
            
            // 设置定时刷新（作为备用方案）
            setInterval(() => {
                if (!socket || !socket.connected) {
                    loadDashboardData();
                    loadRecentEvents();
                }
            }, 60000); // 每60秒刷新一次（如果Socket断开）
        });

        // 初始化Socket.IO连接
        function initSocketConnection() {
            socket = io();
            
            // 连接成功
            socket.on('connect', () => {
                console.log('Dashboard connected to server');
            });
            
            // 连接断开
            socket.on('disconnect', () => {
                console.log('Dashboard disconnected from server');
            });
            
            // 监听新事件
            socket.on('new_event', (data) => {
                updateDashboardRealtime(data);
            });
            
            // 监听统计数据更新
            socket.on('stats_update', (data) => {
                updateStatsRealtime(data);
            });
        }

        // 实时更新仪表盘数据
        function updateDashboardRealtime(eventData) {
            // 更新统计卡片
            realtimeData.todayEvents++;
            realtimeData.totalEvents++;
            
            // 如果是高风险事件
            if (eventData.severity === 'high' || eventData.severity === '高') {
                realtimeData.highRiskEvents++;
            }
            
            // 更新显示
            updateStatsDisplay();
            
            // 更新趋势图
            updateTrendChartRealtime(eventData);
            
            // 更新事件类型图
            updateTypeChartRealtime(eventData);
            
            // 更新最近事件列表
            addRecentEventRealtime(eventData);
        }

        // 实时更新统计数据
        function updateStatsRealtime(data) {
            realtimeData = { ...realtimeData, ...data };
            updateStatsDisplay();
        }

        // 更新统计显示
        function updateStatsDisplay() {
            document.getElementById('todayEvents').textContent = realtimeData.todayEvents;
            document.getElementById('highRiskEvents').textContent = realtimeData.highRiskEvents;
            document.getElementById('eventTypes').textContent = realtimeData.eventTypes;
            document.getElementById('totalEvents').textContent = realtimeData.totalEvents;
        }

        // 实时更新趋势图
        function updateTrendChartRealtime(eventData) {
            if (!trendChart) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // 获取当前数据
            const chartData = trendChart.data;
            const labels = chartData.labels;
            const data = chartData.datasets[0].data;
            
            // 如果标签数量超过12个，移除最旧的
            if (labels.length >= 12) {
                labels.shift();
                data.shift();
            }
            
            // 添加新数据点
            labels.push(timeStr);
            data.push(1); // 每个事件增加1
            
            // 更新图表
            trendChart.update('none'); // 使用 'none' 模式避免动画延迟
        }

        // 实时更新事件类型图
        function updateTypeChartRealtime(eventData) {
            if (!typeChart) return;
            
            const chartData = typeChart.data;
            const labels = chartData.labels;
            const data = chartData.datasets[0].data;
            
            const eventType = eventData.event_type || '未知类型';
            const typeIndex = labels.indexOf(eventType);
            
            if (typeIndex !== -1) {
                // 如果类型已存在，增加计数
                data[typeIndex]++;
            } else {
                // 如果类型不存在，添加新类型
                labels.push(eventType);
                data.push(1);
                
                // 添加新的颜色
                const colors = [
                    '#165DFF','#0FC6C2','#FF7D00','#F53F3F','#722ED1',
                    '#00B42A','#86909C','#FFB800','#F5319D','#7C3AED'
                ];
                chartData.datasets[0].backgroundColor.push(colors[labels.length % colors.length]);
            }
            
            // 更新图表
            typeChart.update('none');
        }

        // 实时添加最近事件
        function addRecentEventRealtime(eventData) {
            const tbody = document.getElementById('recentEventsTable');
            
            // 格式化时间显示
            let timeDisplay = '未知时间';
            if (eventData.timestamp) {
                try {
                    const eventTime = new Date(eventData.timestamp);
                    timeDisplay = eventTime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    timeDisplay = eventData.timestamp;
                }
            }
            
            // 确定严重级别的样式类
            let severityClass = '';
            let severityText = '';
            if (eventData.severity === 'high' || eventData.severity === '高') {
                severityClass = 'bg-red-100 text-red-800';
                severityText = '高';
            } else if (eventData.severity === 'medium' || eventData.severity === '中') {
                severityClass = 'bg-yellow-100 text-yellow-800';
                severityText = '中';
            } else {
                severityClass = 'bg-green-100 text-green-800';
                severityText = '低';
            }
            
            // 确定状态样式
            let statusClass = '';
            let statusText = '';
            if (eventData.status === 'blocked') {
                statusClass = 'bg-red-100 text-red-800';
                statusText = '已阻止';
            } else if (eventData.status === 'ignored') {
                statusClass = 'bg-gray-100 text-gray-800';
                statusText = '已忽略';
            } else {
                statusClass = 'bg-blue-100 text-blue-800';
                statusText = '已检测';
            }
            
            const newRow = document.createElement('tr');
            newRow.className = 'table-row border-b border-gray-100 new-event-row';
            newRow.style.animation = 'fadeIn 0.5s ease-in';
            
            newRow.innerHTML = `
                <td class="py-3 px-4 text-sm">
                    <div class="flex flex-col">
                        <span class="font-medium">${timeDisplay.split(' ')[0]}</span>
                        <span class="text-xs text-gray-500">${timeDisplay.split(' ')[1]}</span>
                    </div>
                </td>
                <td class="py-3 px-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="font-mono">${eventData.ip_address || '未知'}</span>
                        <button class="text-xs text-blue-600 hover:text-blue-800" onclick="blockIP('${eventData.ip_address}')" title="阻止IP">
                            <i class="fa fa-shield"></i>
                        </button>
                    </div>
                </td>
                <td class="py-3 px-4 text-sm">
                    <div class="flex flex-col">
                        <span class="font-medium">${eventData.event_type || '未知'}</span>
                        <span class="text-xs text-gray-500 truncate" title="${eventData.request_path || ''}">${eventData.request_path || ''}</span>
                    </div>
                </td>
                <td class="py-3 px-4 text-sm">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${severityClass}">
                        ${severityText}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="py-3 px-4 text-sm">
                    <div class="flex items-center gap-2">
                        <button class="text-primary hover:text-primary/80" onclick="viewEventDetails(${eventData.id})" title="查看详情">
                            <i class="fa fa-eye"></i>
                        </button>
                        <button class="text-gray-600 hover:text-gray-800" onclick="ignoreEvent(${eventData.id})" title="忽略事件">
                            <i class="fa fa-ban"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800" onclick="blockIP('${eventData.ip_address}')" title="阻止IP">
                            <i class="fa fa-shield"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // 插入到表格顶部
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // 限制最近事件数量为10个
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 10) {
                tbody.removeChild(rows[rows.length - 1]);
            }
            
            // 移除动画类
            setTimeout(() => {
                newRow.classList.remove('new-event-row');
            }, 500);
            
            // 更新统计摘要
            updateRecentEventsStatsRealtime(eventData);
        }

        // 实时更新最近事件统计摘要
        function updateRecentEventsStatsRealtime(eventData) {
            const highRiskElement = document.getElementById('recentHighRisk');
            const mediumRiskElement = document.getElementById('recentMediumRisk');
            const lowRiskElement = document.getElementById('recentLowRisk');
            const totalElement = document.getElementById('recentTotal');
            
            if (highRiskElement && mediumRiskElement && lowRiskElement && totalElement) {
                let high = parseInt(highRiskElement.textContent) || 0;
                let medium = parseInt(mediumRiskElement.textContent) || 0;
                let low = parseInt(lowRiskElement.textContent) || 0;
                let total = parseInt(totalElement.textContent) || 0;
                
                if (eventData.severity === 'high' || eventData.severity === '高') {
                    high++;
                } else if (eventData.severity === 'medium' || eventData.severity === '中') {
                    medium++;
                } else {
                    low++;
                }
                total++;
                
                highRiskElement.textContent = high;
                mediumRiskElement.textContent = medium;
                lowRiskElement.textContent = low;
                totalElement.textContent = total;
            }
        }

        // 加载仪表盘统计数据
        function loadDashboardData() {
            fetch('/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    // 更新实时数据
                    realtimeData.todayEvents = data.today_events || 0;
                    realtimeData.highRiskEvents = data.high_risk_events || 0;
                    realtimeData.eventTypes = data.event_types || 0;
                    realtimeData.totalEvents = data.total_events || 0;
                    
                    // 更新显示
                    updateStatsDisplay();
                    
                    // 加载图表数据
                    loadChartData();
                })
                .catch(error => {
                    console.error('Error loading dashboard stats:', error);
                });
        }

        // 加载图表数据
        function loadChartData() {
            fetch('/api/index-stats')
                .then(res => res.json())
                .then(data => {
                    // 保存趋势数据用于实时更新
                    realtimeData.trendData = data.trend || [];
                    realtimeData.typeData = data.event_type_stats || [];
                    
                    // 事件趋势图表
                    const trendCtx = document.getElementById('eventTrendChart').getContext('2d');
                    
                    // 销毁现有图表
                    if (trendChart) {
                        trendChart.destroy();
                    }
                    
                    // 准备实时趋势数据（最近12个时间点）
                    const trendLabels = data.trend ? data.trend.slice(-12).map(item => item.date) : [];
                    const trendCounts = data.trend ? data.trend.slice(-12).map(item => item.count) : [];
                    
                    trendChart = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: trendLabels,
                            datasets: [{
                                label: '事件数量',
                                data: trendCounts,
                                borderColor: '#165DFF',
                                backgroundColor: 'rgba(22, 93, 255, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#165DFF',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: { 
                                    mode: 'index', 
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#165DFF',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    grid: { 
                                        color: 'rgba(0,0,0,0.05)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#86909C',
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                x: { 
                                    grid: { display: false },
                                    ticks: {
                                        color: '#86909C',
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            animation: {
                                duration: 300
                            }
                        }
                    });
                    
                    // 事件分类图表
                    const typeCtx = document.getElementById('eventTypeChart').getContext('2d');
                    
                    // 销毁现有图表
                    if (typeChart) {
                        typeChart.destroy();
                    }
                    
                    typeChart = new Chart(typeCtx, {
                        type: 'doughnut',
                        data: {
                            labels: data.event_type_stats.map(item => item.type),
                            datasets: [{
                                data: data.event_type_stats.map(item => item.count),
                                backgroundColor: [
                                    '#165DFF','#0FC6C2','#FF7D00','#F53F3F','#722ED1',
                                    '#00B42A','#86909C','#FFB800','#F5319D','#7C3AED'
                                ],
                                borderWidth: 0,
                                hoverBorderWidth: 2,
                                hoverBorderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { 
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#165DFF',
                                    borderWidth: 1
                                }
                            },
                            cutout: '70%',
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 300
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                });
        }

        // 加载最近事件
        function loadRecentEvents() {
            showRecentEventsLoading();
            
            fetch('/api/dashboard/recent-events?limit=10')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('API Error:', data.error);
                        showRecentEventsError();
                        return;
                    }
                    
                    const tbody = document.getElementById('recentEventsTable');
                    tbody.innerHTML = '';
                    
                    if (data.events && data.events.length > 0) {
                        // 统计各风险级别的事件数量
                        const stats = {
                            high: 0,
                            medium: 0,
                            low: 0,
                            total: data.events.length
                        };
                        
                        data.events.forEach(event => {
                            const row = document.createElement('tr');
                            row.className = 'table-row border-b border-gray-100 hover:bg-gray-50 transition-colors';
                            
                            // 格式化时间显示
                            let timeDisplay = '未知时间';
                            if (event.timestamp) {
                                try {
                                    const eventTime = new Date(event.timestamp);
                                    timeDisplay = eventTime.toLocaleString('zh-CN', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit'
                                    });
                                } catch (e) {
                                    timeDisplay = event.timestamp;
                                }
                            }
                            
                            // 确定严重级别的样式类
                            let severityClass = '';
                            let severityText = '';
                            if (event.severity === 'high' || event.severity === '高') {
                                severityClass = 'bg-red-100 text-red-800';
                                severityText = '高';
                                stats.high++;
                            } else if (event.severity === 'medium' || event.severity === '中') {
                                severityClass = 'bg-yellow-100 text-yellow-800';
                                severityText = '中';
                                stats.medium++;
                            } else {
                                severityClass = 'bg-green-100 text-green-800';
                                severityText = '低';
                                stats.low++;
                            }
                            
                            // 确定状态样式
                            let statusClass = '';
                            let statusText = '';
                            if (event.status === 'blocked') {
                                statusClass = 'bg-red-100 text-red-800';
                                statusText = '已阻止';
                            } else if (event.status === 'ignored') {
                                statusClass = 'bg-gray-100 text-gray-800';
                                statusText = '已忽略';
                            } else {
                                statusClass = 'bg-blue-100 text-blue-800';
                                statusText = '已检测';
                            }
                            
                            row.innerHTML = `
                                <td class="py-3 px-4 text-sm">
                                    <div class="flex flex-col">
                                        <span class="font-medium">${timeDisplay.split(' ')[0]}</span>
                                        <span class="text-xs text-gray-500">${timeDisplay.split(' ')[1]}</span>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono">${event.ip_address}</span>
                                        <button class="text-xs text-blue-600 hover:text-blue-800" onclick="blockIP('${event.ip_address}')" title="阻止IP">
                                            <i class="fa fa-shield"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <div class="flex flex-col">
                                        <span class="font-medium">${event.event_type}</span>
                                        <span class="text-xs text-gray-500 truncate" title="${event.request_path}">${event.request_path}</span>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${severityClass}">
                                        ${severityText}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <button class="text-primary hover:text-primary/80" onclick="viewEventDetails(${event.id})" title="查看详情">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                        <button class="text-gray-600 hover:text-gray-800" onclick="ignoreEvent(${event.id})" title="忽略事件">
                                            <i class="fa fa-ban"></i>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800" onclick="blockIP('${event.ip_address}')" title="阻止IP">
                                            <i class="fa fa-shield"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        // 更新统计摘要
                        updateRecentEventsStats(stats);
                        showRecentEventsTable();
                    } else {
                        showRecentEventsEmpty();
                    }
                })
                .catch(error => {
                    console.error('Error loading recent events:', error);
                    showRecentEventsError();
                });
        }

        // 更新最近事件统计摘要
        function updateRecentEventsStats(stats) {
            document.getElementById('recentHighRisk').textContent = stats.high;
            document.getElementById('recentMediumRisk').textContent = stats.medium;
            document.getElementById('recentLowRisk').textContent = stats.low;
            document.getElementById('recentTotal').textContent = stats.total;
        }

        // 显示最近事件加载状态
        function showRecentEventsLoading() {
            document.getElementById('recentEventsTable').parentElement.classList.add('hidden');
            document.getElementById('recentEventsLoading').classList.remove('hidden');
            document.getElementById('recentEventsEmpty').classList.add('hidden');
            document.getElementById('recentEventsError').classList.add('hidden');
        }

        // 显示最近事件表格
        function showRecentEventsTable() {
            document.getElementById('recentEventsTable').parentElement.classList.remove('hidden');
            document.getElementById('recentEventsLoading').classList.add('hidden');
            document.getElementById('recentEventsEmpty').classList.add('hidden');
            document.getElementById('recentEventsError').classList.add('hidden');
        }

        // 显示最近事件空状态
        function showRecentEventsEmpty() {
            document.getElementById('recentEventsTable').parentElement.classList.add('hidden');
            document.getElementById('recentEventsLoading').classList.add('hidden');
            document.getElementById('recentEventsEmpty').classList.remove('hidden');
            document.getElementById('recentEventsError').classList.add('hidden');
        }

        // 显示最近事件错误状态
        function showRecentEventsError() {
            document.getElementById('recentEventsTable').parentElement.classList.add('hidden');
            document.getElementById('recentEventsLoading').classList.add('hidden');
            document.getElementById('recentEventsEmpty').classList.add('hidden');
            document.getElementById('recentEventsError').classList.remove('hidden');
        }

        // 刷新最近事件
        function refreshRecentEvents() {
            loadRecentEvents();
        }

        // 忽略事件
        function ignoreEvent(eventId) {
            if (confirm('确定要忽略这个事件吗？')) {
                fetch(`/api/events/${eventId}/ignore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showMessage('success', data.message);
                        loadRecentEvents(); // 重新加载列表
                    } else {
                        showMessage('error', data.error || '忽略事件失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', '忽略事件失败');
                });
            }
        }

        // 阻止IP
        function blockIP(ip) {
            if (confirm(`确定要阻止IP地址 ${ip} 吗？`)) {
                fetch('/api/block_ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ip: ip})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showMessage('success', data.message);
                        loadRecentEvents(); // 重新加载列表
                    } else {
                        showMessage('error', data.error || 'IP阻止失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', 'IP阻止失败');
                });
            }
        }

        // 显示消息
        function showMessage(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 查看事件详情
        function viewEventDetails(eventId) {
            fetch(`/api/events/${eventId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                        return;
                    }
                    
                    const modalContent = document.getElementById('modalContent');
                    
                    // 确定严重级别的样式类
                    let severityClass = '';
                    let severityText = '';
                    if (data.severity === 'high' || data.severity === '高') {
                        severityClass = 'bg-red-100 text-red-800';
                        severityText = '高';
                    } else if (data.severity === 'medium' || data.severity === '中') {
                        severityClass = 'bg-yellow-100 text-yellow-800';
                        severityText = '中';
                    } else {
                        severityClass = 'bg-green-100 text-green-800';
                        severityText = '低';
                    }
                    
                    // 确定状态样式
                    let statusClass = '';
                    let statusText = '';
                    if (data.status === 'blocked') {
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = '已阻止';
                    } else if (data.status === 'ignored') {
                        statusClass = 'bg-gray-100 text-gray-800';
                        statusText = '已忽略';
                    } else {
                        statusClass = 'bg-blue-100 text-blue-800';
                        statusText = '已检测';
                    }
                    
                    // 格式化时间
                    let formattedTime = '未知时间';
                    if (data.timestamp) {
                        try {
                            const eventTime = new Date(data.timestamp);
                            formattedTime = eventTime.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        } catch (e) {
                            formattedTime = data.timestamp;
                        }
                    }
                    
                    // 获取匹配的模式
                    const matchedPattern = data.rule_pattern || '未匹配到具体规则';
                    
                    modalContent.innerHTML = `
                        <div class="space-y-6">
                            <!-- 事件基本信息 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500">事件ID</p>
                                    <p class="font-medium">#${data.id}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">时间戳</p>
                                    <p class="font-medium">${formattedTime}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">IP地址</p>
                                    <p class="font-medium font-mono">${data.ip_address}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">严重级别</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${severityClass}">
                                        ${severityText}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">状态</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">事件类型</p>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        ${data.event_type}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- 请求信息 -->
                            <div>
                                <h4 class="font-medium mb-3">请求信息</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500">请求路径</p>
                                        <p class="font-medium text-sm break-all">${data.request_path}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">请求方法</p>
                                        <p class="font-medium">${data.request_method}</p>
                                    </div>
                                    <div class="md:col-span-2">
                                        <p class="text-sm text-gray-500">用户代理</p>
                                        <p class="font-medium text-sm break-all">${data.user_agent}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 匹配的模式 -->
                            <div>
                                <h4 class="font-medium mb-3">匹配的模式</h4>
                                <pre class="bg-gray-50 p-3 rounded-lg text-sm overflow-x-auto">${matchedPattern}</pre>
                            </div>
                            
                            <!-- 请求数据 -->
                            <div>
                                <h4 class="font-medium mb-3">请求数据</h4>
                                <div class="bg-gray-50 p-3 rounded-lg text-sm">
                                    <pre class="text-xs overflow-x-auto break-all">${JSON.stringify(data.request_data, null, 2)}</pre>
                                </div>
                            </div>
                        </div>
                    `;

                    // 显示模态框
                    document.getElementById('eventDetailsModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('error', '获取事件详情失败');
                });
        }
    </script>
</body>
</html>