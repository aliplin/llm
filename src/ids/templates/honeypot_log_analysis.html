<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蜜罐日志分析 - 入侵检测系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0FC6C2',
                        danger: '#F53F3F',
                        warning: '#FF7D00',
                        success: '#00B42A',
                        info: '#86909C',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .sidebar-item {
                @apply flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300;
            }
            .sidebar-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .sidebar-item:not(.active):hover {
                @apply bg-gray-100;
            }
            .stat-card {
                @apply bg-white rounded-xl p-5 card-shadow transition-all duration-300 hover:shadow-lg;
            }
            .btn {
                @apply px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90;
            }
            .btn-outline {
                @apply border border-gray-300 hover:bg-gray-100;
            }
            .table-row {
                @apply transition-all duration-300 hover:bg-gray-50;
            }
            .service-btn {
                @apply px-4 py-2 rounded-lg border border-gray-200 font-medium transition-all duration-300 flex items-center justify-center gap-2;
            }
            .service-btn.active {
                @apply bg-primary/10 text-primary border-primary;
            }
            .log-filter {
                @apply px-4 py-2 rounded-lg border border-gray-200 font-medium transition-all duration-300 flex items-center justify-center gap-2 mr-2 mb-2;
            }
            .log-filter.active {
                @apply bg-primary/10 text-primary border-primary;
            }
            .log-container {
                @apply mt-4 max-h-96 overflow-y-auto;
            }
            .log-entry {
                @apply p-3 border-b border-gray-100;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:block transition-all duration-300">
            <div class="p-5 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <i class="fa fa-shield text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold">入侵检测系统</h1>
                </div>
            </div>
            <nav class="p-4">
                <div class="mb-6">
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">主菜单</p>
                    <a href="{{ url_for('main.index') }}" class="sidebar-item">
                        <i class="fa fa-dashboard"></i>
                        <span>仪表盘</span>
                    </a>
                    <a href="{{ url_for('main.honeypot_log_analysis') }}" class="sidebar-item active">
                        <i class="fa fa-flask"></i>
                        <span>蜜罐网络安全日志分析</span>
                    </a>
                    <a href="{{ url_for('main.llm_status') }}" class="sidebar-item">
                        <i class="fa fa-brain"></i>
                        <span>LLM状态</span>
                    </a>
                    <a href="{{ url_for('events.events') }}" class="sidebar-item">
                        <i class="fa fa-list-alt"></i>
                        <span>事件日志</span>
                    </a>
                    <a href="{{ url_for('main.realtime') }}" class="sidebar-item">
                        <i class="fa fa-globe"></i>
                        <span>实时监控</span>
                    </a>
                    <a href="{{ url_for('rules.rules') }}" class="sidebar-item">
                        <i class="fa fa-gavel"></i>
                        <span>检测规则</span>
                    </a>
                </div>
                <div>
                    <p class="text-xs uppercase text-gray-400 font-semibold px-4 mb-3">系统</p>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-cog"></i>
                        <span>系统设置</span>
                    </a>
                    <a href="#" class="sidebar-item">
                        <i class="fa fa-line-chart"></i>
                        <span>性能监控</span>
                    </a>
                </div>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-medium">{{ current_user.username }}</p>
                        <p class="text-xs text-gray-500">管理员</p>
                    </div>
                    <div class="ml-auto">
                        <a href="{{ url_for('auth.logout') }}" class="text-gray-400 hover:text-danger transition-colors">
                            <i class="fa fa-sign-out"></i>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white border-b border-gray-200 py-3 px-6 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden text-gray-500 hover:text-primary mr-4">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                    <div class="relative">
                        <h1 class="text-xl font-bold">蜜罐日志分析</h1>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="relative text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-bell text-xl"></i>
                        <span class="absolute -top-1 -right-1 bg-danger text-white text-xs w-4 h-4 flex items-center justify-center rounded-full">3</span>
                    </button>
                    <button class="text-gray-500 hover:text-primary transition-colors">
                        <i class="fa fa-question-circle text-xl"></i>
                    </button>
                    <div class="hidden md:flex items-center gap-3">
                        <img src="https://picsum.photos/id/1005/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
                        <span class="font-medium">{{ current_user.username }}</span>
                    </div>
                </div>
            </header>

            <!-- 页面内容 -->
            <main class="flex-1 overflow-y-auto p-6">
                <div class="mb-8">
                    <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">蜜罐日志分析</h2>
                    <p class="text-gray-500">实时监控蜜罐系统的安全状态</p>
                </div>

                <!-- 统计卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">总会话数</h3>
                            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                <i class="fa fa-users"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="total-sessions">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">攻击事件</h3>
                            <div class="w-10 h-10 rounded-full bg-danger/10 flex items-center justify-center text-danger">
                                <i class="fa fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="total-attacks">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">活跃会话</h3>
                            <div class="w-10 h-10 rounded-full bg-secondary/10 flex items-center justify-center text-secondary">
                                <i class="fa fa-user"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="active-sessions">0</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-500 font-medium">最后更新</h3>
                            <div class="w-10 h-10 rounded-full bg-info/10 flex items-center justify-center text-info">
                                <i class="fa fa-clock"></i>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-bold" id="last-update">--</p>
                        </div>
                    </div>
                </div>

                <!-- 控制面板 -->
                <div class="bg-white rounded-xl p-5 card-shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <h3><i class="fa fa-cogs"></i> 数据控制</h3>
                            <div class="flex gap-3">
                                <button id="refreshBtn" class="btn btn-primary">
                                    <i class="fa fa-sync-alt"></i> 刷新数据
                                </button>
                                <button id="exportBtn" class="btn btn-secondary">
                                    <i class="fa fa-download"></i> 导出报告
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3><i class="fa fa-filter"></i> 服务筛选</h3>
                            <div class="flex flex-wrap gap-2">
                                <button id="sshSessionsBtn" class="service-btn active">
                                    <i class="fa fa-terminal"></i> SSH
                                </button>
                                <button id="httpSessionsBtn" class="service-btn">
                                    <i class="fa fa-globe"></i> HTTP
                                </button>
                                <button id="mysqlSessionsBtn" class="service-btn">
                                    <i class="fa fa-database"></i> MySQL
                                </button>
                                <button id="pop3SessionsBtn" class="service-btn">
                                    <i class="fa fa-envelope"></i> POP3
                                </button>
                            </div>
                        </div>

                        <div>
                            <h3><i class="fa fa-chart-line"></i> 时间范围</h3>
                            <select id="timeRange" class="form-select">
                                <option value="1">最近1小时</option>
                                <option value="24" selected>最近24小时</option>
                                <option value="168">最近7天</option>
                                <option value="720">最近30天</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-line"></i> 会话趋势</h3>
                        <div class="h-80">
                            <canvas id="sessionsTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-pie"></i> 服务分布</h3>
                        <div class="h-80">
                            <canvas id="serviceDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-5 card-shadow">
                        <h3><i class="fa fa-chart-bar"></i> 攻击类型统计</h3>
                        <div class="h-80">
                            <canvas id="attackTypesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 实时日志流 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3><i class="fa fa-stream"></i> 实时日志流</h3>
                        <div class="flex items-center gap-2">
                            <button id="exportLogsBtn" class="btn btn-outline text-sm">
                                <i class="fa fa-download"></i> 导出日志
                            </button>
                            <button id="clearLogsBtn" class="btn btn-outline text-sm">
                                <i class="fa fa-trash"></i> 清空
                            </button>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="autoScroll" checked class="rounded">
                                <span>自动滚动</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 搜索和过滤区域 -->
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-4 items-center">
                            <!-- 日志类型过滤 -->
                            <div class="flex flex-wrap gap-2">
                                <button class="log-filter active" data-level="all">全部</button>
                                <button class="log-filter" data-level="command">命令</button>
                                <button class="log-filter" data-level="http">HTTP</button>
                                <button class="log-filter" data-level="mysql">MySQL</button>
                                <button class="log-filter" data-level="ssh">SSH</button>
                                <button class="log-filter" data-level="pop3">POP3</button>
                            </div>
                            
                            <!-- 搜索框 -->
                            <div class="flex-1 min-w-64">
                                <div class="relative">
                                    <input type="text" id="logSearch" placeholder="搜索日志内容..." 
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <i class="fa fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            
                            <!-- 时间范围 -->
                            <select id="logTimeRange" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="1">最近1小时</option>
                                <option value="6">最近6小时</option>
                                <option value="24" selected>最近24小时</option>
                                <option value="168">最近7天</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 日志统计 -->
                    <div class="flex justify-between items-center mb-3 text-sm text-gray-600">
                        <span>显示 <span id="logCount">0</span> 条日志</span>
                        <span>最后更新: <span id="lastLogUpdate">--</span></span>
                    </div>
                    
                    <!-- 日志容器 -->
                    <div id="realtimeLogs" class="log-container bg-gray-50 rounded-lg border border-gray-200">
                        <div class="text-gray-500 text-center py-10">加载中...</div>
                    </div>
                </div>

                <!-- 日志详情模态框 -->
                <div id="logDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold">日志详情</h3>
                                <button id="closeLogModal" class="text-gray-400 hover:text-gray-600">
                                    <i class="fa fa-times text-xl"></i>
                                </button>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
                                <div id="logDetailContent">
                                    <!-- 日志详情内容将在这里动态加载 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 会话详情 -->
                <div class="bg-white rounded-xl p-5 card-shadow mt-6">
                    <h3><i class="fa fa-list"></i> 会话详情</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="service-btn active" data-service="ssh">
                            <i class="fa fa-terminal"></i> SSH会话
                        </button>
                        <button class="service-btn" data-service="http">
                            <i class="fa fa-globe"></i> HTTP会话
                        </button>
                        <button class="service-btn" data-service="mysql">
                            <i class="fa fa-database"></i> MySQL会话
                        </button>
                        <button class="service-btn" data-service="pop3">
                            <i class="fa fa-envelope"></i> POP3会话
                        </button>
                    </div>
                    <div id="sessionDetails" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户名/IP</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">源IP</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目标IP</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">端口</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="sessionTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">选择服务类型查看会话详情</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script>
        // 全局变量存储图表实例
        let serviceDistributionChart = null;
        let attackTypesChart = null;
        let sessionsTrendChart = null;
        let currentLogs = []; // 存储当前日志数据
        let logSearchTimeout = null; // 搜索防抖
        let socket = null; // WebSocket连接

        // 初始化仪表板
        async function initializeDashboard() {
            console.log('Initializing dashboard...');
            
            // 初始化WebSocket连接
            initWebSocket();
            
            await updateStats();
            await initializeCharts();
            setupEventListeners();
            updateLastUpdateTime();

            // 设置定时刷新（作为WebSocket的备用方案）
            setInterval(async () => {
                await updateStats();
                await updateCharts();
                // 如果WebSocket未连接，则使用轮询
                if (!socket || !socket.connected) {
                    await loadRealtimeLogs();
                }
                updateLastUpdateTime();
            }, 30000); // 每30秒刷新一次
        }

        // 更新统计信息
        async function updateStats() {
            try {
                const response = await fetch('/api/overview-stats');
                const data = await response.json();

                document.getElementById('total-sessions').textContent = data.total_sessions || 0;
                document.getElementById('total-attacks').textContent = data.total_attacks || 0;
                document.getElementById('active-sessions').textContent = data.active_sessions || 0;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        // 初始化图表
        async function initializeCharts() {
            try {
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                // 服务分布图表
                const serviceDistributionCtx = document.getElementById('serviceDistributionChart').getContext('2d');
                serviceDistributionChart = new Chart(serviceDistributionCtx, {
                    type: 'pie',
                    data: {
                        labels: data.service_distribution.labels,
                        datasets: [
                            {
                                data: data.service_distribution.data,
                                backgroundColor: ['#165DFF', '#0FC6C2', '#F53F3F', '#FF7D00', '#00B42A', '#86909C']
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
                // 攻击类型统计图表
                const attackTypesCtx = document.getElementById('attackTypesChart').getContext('2d');
                attackTypesChart = new Chart(attackTypesCtx, {
                    type: 'bar',
                    data: {
                        labels: data.attack_types.labels,
                        datasets: [
                            {
                                label: '攻击次数',
                                data: data.attack_types.data,
                                backgroundColor: '#165DFF'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                // 会话趋势图表
                await loadSessionTrendChart();
                // 加载实时日志
                await loadRealtimeLogs();
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // 更新图表数据
        async function updateCharts() {
            try {
                const response = await fetch('/api/chart-data');
                const data = await response.json();
                // 更新服务分布图表
                if (serviceDistributionChart) {
                    serviceDistributionChart.data.labels = data.service_distribution.labels;
                    serviceDistributionChart.data.datasets[0].data = data.service_distribution.data;
                    serviceDistributionChart.update();
                }
                // 更新攻击类型图表
                if (attackTypesChart) {
                    attackTypesChart.data.labels = data.attack_types.labels;
                    attackTypesChart.data.datasets[0].data = data.attack_types.data;
                    attackTypesChart.update();
                }
                // 更新会话趋势图表
                await loadSessionTrendChart();
                // 更新实时日志（仅在WebSocket未连接时）
                if (!socket || !socket.connected) {
                    await loadRealtimeLogs();
                }
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // 加载会话趋势图表
        async function loadSessionTrendChart() {
            try {
                const timeRange = document.getElementById('timeRange').value;
                const response = await fetch(`/api/session-trend?time_range=${timeRange}`);
                const data = await response.json();

                const ctx = document.getElementById('sessionsTrendChart').getContext('2d');

                // 如果图表已存在，销毁它
                if (sessionsTrendChart) {
                    sessionsTrendChart.destroy();
                }

                // 创建新图表
                sessionsTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'SSH会话',
                                data: data.ssh_sessions,
                                borderColor: '#165DFF',
                                backgroundColor: 'rgba(22, 93, 255, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'HTTP会话',
                                data: data.http_sessions,
                                borderColor: '#0FC6C2',
                                backgroundColor: 'rgba(15, 198, 194, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'MySQL会话',
                                data: data.mysql_sessions,
                                borderColor: '#F53F3F',
                                backgroundColor: 'rgba(245, 63, 63, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'POP3会话',
                                data: data.pop3_sessions,
                                borderColor: '#FF7D00',
                                backgroundColor: 'rgba(255, 125, 0, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching session trend data:', error);
            }
        }

        // 加载实时日志（轮询方式，作为WebSocket的备用）
        async function loadRealtimeLogs() {
            try {
                const selectedLevel = document.querySelector('.log-filter.active').dataset.level;
                const timeRange = document.getElementById('logTimeRange').value;
                const searchTerm = document.getElementById('logSearch').value;
                
                const response = await fetch(`/api/realtime-logs?level=${selectedLevel}&time_range=${timeRange}&search=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();

                // 保存当前日志数据
                currentLogs = data.logs || [];
                
                // 更新日志显示
                updateLogDisplay();
            } catch (error) {
                console.error('Error fetching realtime logs:', error);
                document.getElementById('realtimeLogs').innerHTML = '<div class="text-red-500 text-center py-10">加载日志失败</div>';
            }
        }

        // 获取日志类型对应的CSS类
        function getLogTypeClass(type) {
            switch (type.toLowerCase()) {
                case 'command':
                    return 'bg-blue-50';
                case 'http':
                    return 'bg-green-50';
                case 'ssh':
                    return 'bg-purple-50';
                case 'mysql':
                    return 'bg-orange-50';
                case 'pop3':
                    return 'bg-pink-50';
                default:
                    return '';
            }
        }

        // 获取日志类型文本对应的CSS类
        function getLogTypeTextClass(type) {
            switch (type.toLowerCase()) {
                case 'command':
                    return 'text-blue-600';
                case 'http':
                    return 'text-green-600';
                case 'ssh':
                    return 'text-purple-600';
                case 'mysql':
                    return 'text-orange-600';
                case 'pop3':
                    return 'text-pink-600';
                default:
                    return 'text-gray-600';
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 刷新按钮
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                await updateStats();
                await updateCharts();
                updateLastUpdateTime();
                showNotification('数据已刷新');
            });

            // 导出报告按钮
            document.getElementById('exportBtn').addEventListener('click', exportReport);

            // 服务筛选按钮
            document.querySelectorAll('.service-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.service-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // 加载会话详情
                    const serviceType = btn.dataset.service;
                    loadSessionDetails(serviceType);
                });
            });

            // 时间范围选择
            document.getElementById('timeRange').addEventListener('change', loadSessionTrendChart);

            // 日志过滤器
            document.querySelectorAll('.log-filter').forEach(filter => {
                filter.addEventListener('click', () => {
                    document.querySelectorAll('.log-filter').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    // 使用实时更新显示
                    updateLogDisplay();
                });
            });

            // 日志时间范围选择
            document.getElementById('logTimeRange').addEventListener('change', () => {
                // 重新加载日志数据
                loadRealtimeLogs();
            });

            // 日志搜索
            document.getElementById('logSearch').addEventListener('input', () => {
                // 使用实时更新显示
                updateLogDisplay();
            });

            // 导出日志按钮
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);

            // 清空日志按钮
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);

            // 关闭日志详情模态框
            document.getElementById('closeLogModal').addEventListener('click', () => {
                document.getElementById('logDetailModal').classList.add('hidden');
            });

            // 点击模态框背景关闭
            document.getElementById('logDetailModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('logDetailModal')) {
                    document.getElementById('logDetailModal').classList.add('hidden');
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('logDetailModal').classList.add('hidden');
                }
            });

            // 初始化时加载SSH会话详情
            loadSessionDetails('ssh');
        }

        // 加载会话详情
        async function loadSessionDetails(serviceType) {
            try {
                const response = await fetch(`/api/session-details/${serviceType}`);
                const data = await response.json();

                const tableBody = document.getElementById('sessionTableBody');
                tableBody.innerHTML = '';

                if (!data.sessions || data.sessions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无会话数据</td></tr>';
                    return;
                }

                data.sessions.forEach(session => {
                    const row = document.createElement('tr');
                    row.className = 'table-row';

                    let usernameIp = session.username || session.client_ip || '-';
                    let time = session.time_date || session.start_time || '-';
                    let srcIp = session.src_ip || session.client_ip || '-';
                    let dstIp = session.dst_ip || '-';
                    let ports = '';
                    
                    if (session.src_port && session.dst_port) {
                        ports = `${session.src_port} → ${session.dst_port}`;
                    } else if (session.dst_port) {
                        ports = `${session.dst_port}`;
                    } else {
                        ports = '-';
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${session.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${usernameIp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${srcIp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dstIp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ports}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-primary hover:text-primary/80" onclick="viewSessionDetails(${session.id}, '${serviceType}')">
                                <i class="fa fa-eye"></i> 查看
                            </button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading session details:', error);
                document.getElementById('sessionTableBody').innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">加载会话详情失败</td></tr>';
            }
        }

        // 查看会话详情
        function viewSessionDetails(sessionId, serviceType) {
            // 这里可以添加查看详细信息的逻辑
            showNotification(`查看 ${serviceType.toUpperCase()} 会话 ${sessionId} 的详细信息`, 'info');
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('last-update');
            const now = new Date();
            const dateTime = now.toLocaleString();
            lastUpdateElement.textContent = dateTime;
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${getNotificationClass(type)}`;

            const iconMap = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle'
            };

            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fa ${iconMap[type]}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 10);

            // 自动关闭
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 获取通知类型对应的CSS类
        function getNotificationClass(type) {
            switch (type) {
                case 'success':
                    return 'bg-green-50 text-green-800 border-l-4 border-green-400';
                case 'error':
                    return 'bg-red-50 text-red-800 border-l-4 border-red-400';
                case 'warning':
                    return 'bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400';
                default:
                    return 'bg-blue-50 text-blue-800 border-l-4 border-blue-400';
            }
        }

        // 显示日志详情
        function showLogDetail(log) {
            const modal = document.getElementById('logDetailModal');
            const content = document.getElementById('logDetailContent');
            
            const timestamp = new Date(log.timestamp).toLocaleString();
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日志类型</label>
                            <p class="text-sm bg-gray-50 p-2 rounded">${log.type.toUpperCase()}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">时间戳</label>
                            <p class="text-sm bg-gray-50 p-2 rounded">${timestamp}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日志ID</label>
                            <p class="text-sm bg-gray-50 p-2 rounded">${log.id}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">内容</label>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm whitespace-pre-wrap">${log.content}</div>
                    </div>
                    
                    ${log.response ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">响应</label>
                        <div class="bg-gray-50 p-3 rounded font-mono text-sm whitespace-pre-wrap max-h-64 overflow-y-auto">${log.response}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // 导出报告
        function exportReport() {
            const timeRange = document.getElementById('timeRange').value;
            const reportType = 'csv'; // 默认导出CSV格式
            
            // 显示加载状态
            showNotification('正在生成报告...', 'info');
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = `/api/export-report?type=${reportType}&time_range=${timeRange}`;
            link.download = `honeypot_report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('报告导出成功', 'success');
        }

        // 导出日志
        function exportLogs() {
            if (!currentLogs || currentLogs.length === 0) {
                showNotification('没有日志数据可导出', 'warning');
                return;
            }
            
            const csvContent = generateLogCSV(currentLogs);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `honeypot_logs_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('日志导出成功', 'success');
        }

        // 生成CSV内容
        function generateLogCSV(logs) {
            const headers = ['ID', '类型', '时间戳', '内容', '响应'];
            const rows = logs.map(log => [
                log.id,
                log.type,
                new Date(log.timestamp).toLocaleString(),
                `"${log.content.replace(/"/g, '""')}"`,
                log.response ? `"${log.response.replace(/"/g, '""')}"` : ''
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // 清空日志显示
        function clearLogs() {
            if (confirm('确定要清空当前显示的日志吗？')) {
                currentLogs = [];
                document.getElementById('realtimeLogs').innerHTML = '<div class="text-gray-500 text-center py-10">日志已清空</div>';
                document.getElementById('logCount').textContent = '0';
                showNotification('日志已清空', 'info');
            }
        }

        // 搜索日志
        function searchLogs() {
            if (logSearchTimeout) {
                clearTimeout(logSearchTimeout);
            }
            
            logSearchTimeout = setTimeout(() => {
                loadRealtimeLogs();
            }, 300);
        }

        // 初始化WebSocket连接
        function initWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('WebSocket连接成功');
                    socket.emit('join_honeypot_logs');
                    showNotification('实时连接已建立', 'success');
                });
                
                socket.on('disconnect', () => {
                    console.log('WebSocket连接断开');
                    showNotification('实时连接已断开', 'warning');
                });
                
                socket.on('new_honeypot_log', (logData) => {
                    console.log('收到新日志:', logData);
                    // 将新日志添加到列表顶部
                    currentLogs.unshift(logData);
                    
                    // 限制日志数量，避免内存溢出
                    if (currentLogs.length > 1000) {
                        currentLogs = currentLogs.slice(0, 1000);
                    }
                    
                    // 更新日志显示
                    updateLogDisplay();
                    
                    // 显示通知
                    showNotification(`新${logData.type}日志: ${logData.content.substring(0, 50)}...`, 'info');
                });
                
                socket.on('log_stats_update', (stats) => {
                    console.log('日志统计更新:', stats);
                    // 更新统计信息
                    updateLogStats(stats);
                });
                
                socket.on('connected', (data) => {
                    console.log('WebSocket连接确认:', data);
                });
                
                socket.on('joined_room', (data) => {
                    console.log('已加入房间:', data);
                });
                
            } catch (error) {
                console.error('WebSocket连接失败:', error);
                showNotification('实时连接失败，将使用轮询模式', 'warning');
            }
        }

        // 更新日志显示
        function updateLogDisplay() {
            const logsContainer = document.getElementById('realtimeLogs');
            const selectedLevel = document.querySelector('.log-filter.active').dataset.level;
            const searchTerm = document.getElementById('logSearch').value;
            
            // 过滤日志
            let filteredLogs = currentLogs;
            
            // 按类型过滤
            if (selectedLevel !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.type === selectedLevel);
            }
            
            // 按搜索词过滤
            if (searchTerm) {
                filteredLogs = filteredLogs.filter(log => 
                    log.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (log.response && log.response.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            // 更新日志统计
            document.getElementById('logCount').textContent = filteredLogs.length;
            document.getElementById('lastLogUpdate').textContent = new Date().toLocaleTimeString();
            
            // 清空现有日志
            logsContainer.innerHTML = '';
            
            if (filteredLogs.length === 0) {
                logsContainer.innerHTML = '<div class="text-gray-500 text-center py-10">暂无日志数据</div>';
                return;
            }
            
            // 显示过滤后的日志
            filteredLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = `log-entry p-3 border-b border-gray-100 ${getLogTypeClass(log.type)} cursor-pointer hover:bg-gray-50 transition-colors`;
                logElement.onclick = () => showLogDetail(log);
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                
                logElement.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-medium">${log.type.toUpperCase()}</span>
                        <span class="text-xs text-gray-500">${timestamp}</span>
                    </div>
                    <p class="text-sm">${log.content}</p>
                    ${log.response ? `<p class="text-sm text-gray-600 mt-1">响应: ${log.response.substring(0, 100)}${log.response.length > 100 ? '...' : ''}</p>` : ''}
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs ${getLogTypeTextClass(log.type)}">${log.type.toUpperCase()}</span>
                        <span class="text-xs text-gray-500">ID: ${log.id}</span>
                    </div>
                `;
                
                logsContainer.appendChild(logElement);
            });
            
            // 自动滚动到底部（如果启用）
            if (document.getElementById('autoScroll').checked) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }

        // 更新日志统计
        function updateLogStats(stats) {
            // 这里可以更新页面上的统计信息
            console.log('更新日志统计:', stats);
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>